Improve third-party authentication for middleware (complex)
